const extractVariables = (text: string) => {
  // NOTE: This regex might not catch all edge cases, but works for now
  const matches = Array.from(
    text.matchAll(/\{\{\s*([A-Za-z_$][\w$]*)\s*\}\}/g)
  );
  // Debug: log detected variables
  if (matches.length > 0) {
    console.log("extractVariables: found", matches.map((m) => m[1]));
  }
  return Array.from(new Set(matches.map((m) => m[1])));
};

const isDag = (nodes: NodeInstance[], edges: Edge[]) => {
  // TODO: Optimize this if we ever have >100 nodes
  const indegree = new Map<string, number>();
  const graph = new Map<string, string[]>();

  nodes.forEach((n) => {
    indegree.set(n.id, 0);
    graph.set(n.id, []);
  });

  edges.forEach(({ source, target }) => {
    if (!graph.has(source)) return;
    graph.get(source)!.push(target);
    indegree.set(target, (indegree.get(target) ?? 0) + 1);
  });

  // Debug: print graph structure
  console.log("isDag: graph", graph, "indegree", indegree);

  const queue = Array.from(indegree.entries())
    .filter(([, deg]) => deg === 0)
    .map(([id]) => id);

  let visited = 0;
  while (queue.length) {
    const curr = queue.shift()!;
    visited += 1;
    for (const nxt of graph.get(curr) ?? []) {
      indegree.set(nxt, (indegree.get(nxt) ?? 0) - 1);
      if ((indegree.get(nxt) ?? 0) === 0) queue.push(nxt);
    }
  }
  // Debug: print result
  console.log("isDag: visited", visited, "of", nodes.length);
  return visited === nodes.length;
};

const addNode = (type: string) => {
  const template = TEMPLATE_MAP[type];
  if (!template) {
    // Shouldn't happen, but let's log it
    console.log("addNode: unknown type", type);
    return;
  }
  const newId = makeId(type);
  // Debug: log node addition
  console.log("addNode: adding", newId, template);
  setNodes((prev) => [...prev, { id: newId, type }]);
};

const handleSubmit = async () => {
  setIsSubmitting(true);
  // Debug: log submission payload
  console.log("handleSubmit: submitting", { nodes, edges });
  try {
    const response = await fetch("http://localhost:8000/pipelines/parse", {
      method: "POST",
      headers: {
        "Content-Type": "application/json",
      },
      body: JSON.stringify({
        nodes: nodes,
        edges: edges,
      }),
    });

    if (!response.ok) {
      // Debug: log error status
      console.log("handleSubmit: HTTP error", response.status);
      throw new Error(`HTTP error! status: ${response.status}`);
    }

    const data = await response.json();
    // Debug: log backend response
    console.log("handleSubmit: got response", data);

    setAlertData({
      show: true,
      num_nodes: data.num_nodes,
      num_edges: data.num_edges,
      is_dag: data.is_dag,
    });
  } catch (error) {
    console.error("Error submitting pipeline:", error);
    setAlertData({
      show: true,
      error:
        error instanceof Error
          ? error.message
          : "Unknown error occurred. Make sure the backend server is running on http://localhost:8000",
    });
  } finally {
    setIsSubmitting(false);
  }
};